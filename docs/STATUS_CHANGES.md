# Изменения в статусах заявок

**Дата:** 24 октября 2025

## Проблема
Ранее статус `sent_to_commercial` использовался в двух случаях:
1. Когда агент брал заявку в работу
2. Когда агент отправлял заявку в коммерческий отдел

Это создавало путаницу в бизнес-логике.

## Решение
Добавлен новый статус `in_progress` для разделения этих этапов.

## Новая логика статусов

### Жизненный цикл заявки:

1. **`pending`** - Ожидает агента
   - Клиент создал заявку
   - Ожидает, пока агент возьмет ее в работу
   - Цвет: желтый

2. **`in_progress`** - В работе у агента ✨ НОВЫЙ
   - Агент взял заявку в работу
   - Агент обсуждает детали с клиентом
   - Агент может редактировать заявку
   - Цвет: синий

3. **`sent_to_commercial`** - В коммерческом отделе
   - Агент отправил заявку на рассмотрение в коммерческий отдел
   - Ожидает решения от коммерческого отдела
   - Цвет: фиолетовый

4. **`approved`** - Одобрено
   - Коммерческий отдел одобрил заявку
   - Цвет: зеленый

5. **`rejected`** - Отклонено
   - Коммерческий отдел отклонил заявку
   - Цвет: красный

6. **`paid`** - Оплачено
   - Клиент оплатил заявку
   - Цвет: изумрудный

7. **`overdue`** - Просрочено
   - Оплата не поступила в срок
   - Цвет: оранжевый

## Технические изменения

### База данных
- Добавлен новый статус в ENUM: `in_progress`
- Миграция: `2025-10-24-add-in-progress-status.sql`
- Обновлены схемы: `schema.sql`, `init_full_schema.sql`

### Код
- `src/lib/database.ts`: Статус при взятии заявки изменен с `sent_to_commercial` на `in_progress`
- `src/utils/statusHelpers.tsx`: Добавлены тексты и цвета для нового статуса
- `src/components/chat/Chat.tsx`: Обновлена логика разрешений
  - `canSendToCommercial`: только для статуса `in_progress`
  - `canReject`: для `pending`, `in_progress`, `sent_to_commercial`
- Все страницы обновлены для отображения нового статуса

### Разрешения

**Клиент может:**
- Отменить заявку в статусах: `pending`, `in_progress`, `sent_to_commercial`

**Агент может:**
- Взять заявку в работу: `pending` → `in_progress`
- Отправить в коммерческий отдел: `in_progress` → `sent_to_commercial`
- Отклонить заявку: `pending`, `in_progress`, `sent_to_commercial`
- Редактировать заявку: только если он владелец

**Коммерческий отдел может:**
- Одобрить заявку: `sent_to_commercial` → `approved`
- Отклонить заявку: `sent_to_commercial` → `rejected`

## Миграция существующих данных

Существующие заявки со статусом `sent_to_commercial` остаются без изменений.
Новые заявки будут использовать правильный поток статусов.

При необходимости можно выполнить миграцию данных:
```sql
-- Если нужно перевести существующие заявки в in_progress
-- (только если агент назначен, но еще не отправлено в коммерческий отдел)
UPDATE applications 
SET status = 'in_progress' 
WHERE status = 'sent_to_commercial' 
  AND agent_id IS NOT NULL
  -- Добавьте дополнительные условия для определения,
  -- какие заявки действительно в работе у агента
```
