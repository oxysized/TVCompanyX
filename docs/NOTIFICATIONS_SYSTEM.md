# üîî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 23 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–ê –ò –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ê

## üìã –û–±–∑–æ—Ä

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å:
- ‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (PostgreSQL)
- ‚úÖ RESTful API (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
- ‚úÖ Realtime –¥–æ—Å—Ç–∞–≤–∫–æ–π (Socket.io)
- ‚úÖ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º —Å dropdown
- ‚úÖ –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ (Web Notifications API)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –≤–æ –≤—Å–µ—Ö workflow

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `notifications`

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  data JSONB,
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  read_at TIMESTAMPTZ
);
```

### –ò–Ω–¥–µ–∫—Å—ã (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

```sql
CREATE INDEX idx_notifications_user ON notifications(user_id, created_at DESC);
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, created_at DESC) WHERE read = FALSE;
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_created ON notifications(created_at DESC);
CREATE INDEX idx_notifications_user_unread_created ON notifications(user_id, read, created_at DESC);
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `docs/db/migrations/2025-10-23-create-notifications-table.sql`

---

## üîå API Endpoints

### `GET /api/notifications`
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Query Parameters:**
- `?unread=true` - —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

**Response:**
```json
[
  {
    "id": "uuid",
    "user_id": "uuid",
    "type": "status_changed",
    "title": "–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω",
    "message": "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ #abc12345 —Ç–µ–ø–µ—Ä—å: –û–¥–æ–±—Ä–µ–Ω–∞",
    "data": {
      "applicationId": "uuid",
      "newStatus": "approved",
      "statusText": "–û–¥–æ–±—Ä–µ–Ω–∞"
    },
    "read": false,
    "created_at": "2025-10-23T12:00:00Z",
    "read_at": null
  }
]
```

### `POST /api/notifications`
–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**Body:**
```json
{
  "user_id": "uuid",
  "type": "status_changed",
  "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
  "message": "–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
  "data": {
    "custom": "data"
  }
}
```

### `PUT /api/notifications`
–û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ

**Body:**
```json
{
  "id": "uuid"
}
```

### `DELETE /api/notifications`
–û—Ç–º–µ—Ç–∏—Ç—å –í–°–ï —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

### `GET /api/notifications/unread-count`
–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**Response:**
```json
{
  "count": 5
}
```

---

## üî• Realtime (Socket.io)

### –°–æ–±—ã—Ç–∏—è

#### Client ‚Üí Server

**`joinNotifications(userId)`**
–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```javascript
socketService.joinNotifications(user.id)
```

#### Server ‚Üí Client

**`notification`**
–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ realtime
```javascript
socketService.on('notification', (notification) => {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  console.log('–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', notification)
})
```

#### Broadcast

**`sendNotification({userId, notification})`**
–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```javascript
// –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ (API)
sendNotificationToUser(userId, notification)
```

### –ö–æ–º–Ω–∞—Ç—ã

–§–æ—Ä–º–∞—Ç: `user-${userId}`

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é –∫–æ–º–Ω–∞—Ç—É –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

---

## üé® UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç

### `<NotificationBell />`

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/NotificationBell.tsx`  
**–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤:** `src/components/layout/Header.tsx`

#### –§—É–Ω–∫—Ü–∏–∏:

1. **–ó–Ω–∞—á–æ–∫ —Å badge** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö (–º–∞–∫—Å–∏–º—É–º 99+)
2. **Dropdown –º–µ–Ω—é** - —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. **–ö–ª–∏–∫ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç
4. **"–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ"** - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
5. **Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - —á–µ—Ä–µ–∑ Socket.io
6. **–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - popup –≤ Windows/macOS
7. **Polling fallback** - –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫
8. **Click-outside** - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç dropdown
9. **–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è** - "–¢–æ–ª—å–∫–æ —á—Ç–æ", "5 –º–∏–Ω –Ω–∞–∑–∞–¥", "2 —á–∞—Å–∞ –Ω–∞–∑–∞–¥"
10. **–¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞** - –ø–æ —Ç–∏–ø—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```tsx
import NotificationBell from '@/components/NotificationBell'

// –í Header –∏–ª–∏ –ª—é–±–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
<NotificationBell />
```

---

## ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏

**–§–∞–π–ª:** `src/pages/api/applications/[id].ts`  
**–¢—Ä–∏–≥–≥–µ—Ä:** `PUT /api/applications/:id` —Å `body.status`

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- `status_changed` - –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// –ö–æ–≥–¥–∞ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞/–∏–∑–º–µ–Ω–µ–Ω —Å—Ç–∞—Ç—É—Å
await db.createNotification({
  user_id: application.customer_id,
  type: 'status_changed',
  title: '–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω',
  message: '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ #abc12345 —Ç–µ–ø–µ—Ä—å: –û–¥–æ–±—Ä–µ–Ω–∞',
  data: { applicationId, newStatus, statusText }
})

sendNotificationToUser(application.customer_id, notification)
```

### 2. –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ

**–§–∞–π–ª:** `src/pages/api/chat/rooms/[roomId]/messages.ts`  
**–¢—Ä–∏–≥–≥–µ—Ä:** `POST /api/chat/rooms/:roomId/messages`

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- `new_message` - –¥–ª—è –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —á–∞—Ç–∞

**–õ–æ–≥–∏–∫–∞:**
- –ü–∞—Ä—Å–∏—Ç `roomId` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã:
  - `customer-agent-{customerId}-{agentId}`
  - `commercial-agent-{agentId}-app-{appId}`

**–ü—Ä–∏–º–µ—Ä:**
```typescript
await db.createNotification({
  user_id: recipientId,
  type: 'new_message',
  title: '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
  message: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç?',
  data: { roomId, messageId, senderId, senderName }
})

sendNotificationToUser(recipientId, notification)
```

### 3. –í—ã–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏

**–§–∞–π–ª:** `src/pages/api/commissions/[id].ts`  
**–¢—Ä–∏–≥–≥–µ—Ä:** `PUT /api/commissions/:id` —Å–æ `status: 'paid'`

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- `commission_paid` - –¥–ª—è –∞–≥–µ–Ω—Ç–∞ –ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ

**–ü—Ä–∏–º–µ—Ä:**
```typescript
await db.createNotification({
  user_id: commission.agent_id,
  type: 'commission_paid',
  title: '–ö–æ–º–∏—Å—Å–∏—è –≤—ã–ø–ª–∞—á–µ–Ω–∞',
  message: '–í–∞–º –≤—ã–ø–ª–∞—á–µ–Ω–∞ –∫–æ–º–∏—Å—Å–∏—è –≤ —Ä–∞–∑–º–µ—Ä–µ 5000 —Ä—É–±. –∑–∞ –∑–∞—è–≤–∫—É',
  data: { commissionId, applicationId, amount, paymentDate }
})

sendNotificationToUser(commission.agent_id, notification)
```

---

## üì¶ –°–µ—Ä–≤–µ—Ä–Ω—ã–π helper

**–§–∞–π–ª:** `src/lib/socketServer.ts`

### –§—É–Ω–∫—Ü–∏–∏:

#### `getSocket(): Socket`
–ü–æ–ª—É—á–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å Socket.io client connection –∫ —Å–µ—Ä–≤–µ—Ä—É

#### `sendNotificationToUser(userId: string, notification: any): boolean`
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Socket.io

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API:**
```typescript
import { sendNotificationToUser } from '@/lib/socketServer'

// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î
const notification = await db.createNotification(...)
sendNotificationToUser(userId, notification)
```

#### `disconnectSocket(): void`
–û—Ç–∫–ª—é—á–∏—Ç—å Socket.io client (–ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–µ—Ä–∞)

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
SOCKET_URL=http://localhost:4000
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:

1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç
2. –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
3. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –∞–≥–µ–Ω—Ç/–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π
4. –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
5. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É ‚Üí –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–∫—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞)
6. –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ ‚Üí —É–≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (popup)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:

1. –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –∞–≥–µ–Ω—Ç–æ–º
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
3. –£ –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. –ö–ª–∏–∫–Ω—É—Ç—å ‚Üí –ø–µ—Ä–µ–π—Ç–∏ –≤ —á–∞—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏:

1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –±—É—Ö–≥–∞–ª—Ç–µ—Ä/–¥–∏—Ä–µ–∫—Ç–æ—Ä
2. –ù–∞–π—Ç–∏ –∫–æ–º–∏—Å—Å–∏—é —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "paid" —á–µ—Ä–µ–∑ `PUT /api/commissions/:id`
4. –£ –∞–≥–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

---

## üìä –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

| –¢–∏–ø | –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è | –ö—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç | –ù–∞–≤–∏–≥–∞—Ü–∏—è |
|-----|----------------|--------------|-----------|
| `status_changed` | –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ | –ö–ª–∏–µ–Ω—Ç (owner –∑–∞—è–≤–∫–∏) | `/customer/applications` |
| `new_message` | –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ | –í—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —á–∞—Ç–∞ | `/agent/chat` –∏–ª–∏ `/customer/chat` |
| `commission_paid` | –í—ã–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏ | –ê–≥–µ–Ω—Ç | `/agent/commissions` |

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:

–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

1. –í—ã–±—Ä–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `application_reminder`)
2. –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –≤ –Ω—É–∂–Ω–æ–º API endpoint:
   ```typescript
   await db.createNotification({
     user_id: targetUserId,
     type: 'application_reminder',
     title: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ',
     message: '–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞',
     data: { ... }
   })
   sendNotificationToUser(targetUserId, notification)
   ```
3. –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç –≤ `getNotificationColor()` –≤ `NotificationBell.tsx`
4. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–∞ –≤ `handleNotificationClick()` (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è)

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö endpoints
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `user_id` –∏–∑ —Ç–æ–∫–µ–Ω–∞ (–Ω–µ–ª—å–∑—è —á–∏—Ç–∞—Ç—å —á—É–∂–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
- ‚úÖ Socket.io rooms –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `user-${userId}`
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ SQL injection –∑–∞—â–∏—Ç–∞ (prepared statements)

---

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ò–Ω–¥–µ–∫—Å—ã –ë–î:
- Composite –∏–Ω–¥–µ–∫—Å `(user_id, created_at DESC)` - –±—ã—Å—Ç—Ä—ã–π —Å–ø–∏—Å–æ–∫
- Partial –∏–Ω–¥–µ–∫—Å `WHERE read = FALSE` - —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
- –ò–Ω–¥–µ–∫—Å –Ω–∞ `type` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É
- Composite `(user_id, read, created_at DESC)` - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### Frontend:
- Polling –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ (–Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä)
- Socket.io –¥–ª—è instant updates
- Local state management (–Ω–µ Redux)
- Dropdown lazy loading

### Backend:
- Connection pooling (PostgreSQL)
- Socket.io persistent connection
- Async/await non-blocking I/O
- Error handling –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

---

## üìö –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### Backend:
- `pg` - PostgreSQL client
- `socket.io` - Realtime server
- `socket.io-client` - Server-to-server communication
- `jsonwebtoken` - JWT auth

### Frontend:
- `socket.io-client` - Realtime client
- React hooks (useState, useEffect, useRef)
- Tailwind CSS - —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è
- Heroicons - –∏–∫–æ–Ω–∫–∏

---

## üêõ Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ realtime:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—â–µ–Ω –ª–∏ Socket.io —Å–µ—Ä–≤–µ—Ä: `npm run socket-server`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –≤ `.env`: `SOCKET_URL=http://localhost:4000`
3. –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `[Socket] Connected`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `[Server] Connected to socket server`

### –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (Settings ‚Üí Notifications)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏: `Notification.permission` ‚Üí –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `"granted"`
3. –ö–ª–∏–∫–Ω—É—Ç—å "–†–∞–∑—Ä–µ—à–∏—Ç—å" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è: `psql -d TVShow -f docs/db/migrations/2025-10-23-create-notifications-table.sql`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É: `SELECT * FROM notifications LIMIT 5;`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î

### –°—á–µ—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `GET /api/notifications/unread-count` –≤ Network tab
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ JWT —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `user_id` –≤ —Ç–æ–∫–µ–Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ë–î

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: —Ç–∞–±–ª–∏—Ü–∞ + –∏–Ω–¥–µ–∫—Å—ã
- [x] –§—É–Ω–∫—Ü–∏–∏ –≤ database.ts (CRUD)
- [x] API endpoints (GET, POST, PUT, DELETE)
- [x] Socket.io server events
- [x] Socket.io client service
- [x] UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç NotificationBell
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Header
- [x] –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [x] Realtime –ø–æ–¥–ø–∏—Å–∫–∞
- [x] –¢—Ä–∏–≥–≥–µ—Ä: –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
- [x] –¢—Ä–∏–≥–≥–µ—Ä: –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
- [x] –¢—Ä–∏–≥–≥–µ—Ä: –≤—ã–ø–ª–∞—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏
- [x] –°–µ—Ä–≤–µ—Ä–Ω—ã–π helper –¥–ª—è Socket.io
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! 

**–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º:**
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π)
- [ ] Push notifications (PWA)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∫–∞–∫–∏–µ —Ç–∏–ø—ã –ø–æ–ª—É—á–∞—Ç—å)
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- [ ] –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ —Ç–∏–ø—É
- [ ] –ó–≤—É–∫–æ–≤—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram bot

---

**–ê–≤—Ç–æ—Ä:** GitHub Copilot  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 23 –æ–∫—Ç—è–±—Ä—è 2025
